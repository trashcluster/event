<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=1280, initial-scale=1.0, maximum-scale=1.0"/>
<title>Program â€“ 1. april</title>

<style>
:root {
  /* base (dark-only) */
  --bg: #0b0b0b;
  --text: #ffffff;
  --muted: #9ca3af;

  /* subject colors (cards) */
  --color-food: #1f3d1a;       /* dark green */
  --color-activity: #7c2a2a;   /* dark red */
  --color-meeting: #b08a00;    /* dark yellow */

  /* soft variants (subcards) */
  --color-food-soft: #2a4f23;
  --color-activity-soft: #a03a3a;
  --color-meeting-soft: #d1a300;

  /* radii */
  --radius-lg: 22px; /* default card radius */
  --radius-md: 16px; /* default subcard radius */
  
  /* canvas */
  --canvas-w: 550px;
  --canvas-h: 1860px;
}

* {
  box-sizing: border-box;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  display: flex;
  justify-content: center;
  min-width: 1280px;
}

.canvas-container{position:relative; width:100%; display:flex; justify-content:center; align-items:flex-start;}
.stage-scaler{}
.app {
  width: var(--canvas-w);
  height: var(--canvas-h);
  max-width: 100%;
  padding: 28px 18px 40px;
  outline: 1px dashed rgba(255,255,255,0.22);
  overflow: hidden;
}

.header {
  text-align: center;
  margin-bottom: 24px;
}

.header .weekday {
  letter-spacing: 2px;
  color: var(--muted);
  font-size: 14px;
}

.header .date {
  font-size: 34px;
  font-weight: 700;
}

.card {
  border-radius: var(--radius-lg);
  padding: 18px 18px 20px;
  margin-bottom: 14px;
}

.card.small {
  padding: 14px 16px;
}

/* subjects map to variables */
.is-food { background: var(--color-food); }
.is-activity { background: var(--color-activity); }
.is-meeting { background: var(--color-meeting); color: #000; }

.time {
  font-size: 14px;
  opacity: 0.9;
}

.title {
  font-size: 26px;
  font-weight: 700;
  margin-top: 2px;
}

.location {
  opacity: 0.85;
}

.stack {
  margin-top: 14px;
  display: grid;
  gap: 12px;
}

.subcard {
  border-radius: var(--radius-md);
  padding: 14px 16px;
}

/* soft backgrounds for subcards */
.is-food-soft { background: var(--color-food-soft); }
.is-activity-soft { background: var(--color-activity-soft); }
.is-meeting-soft { background: var(--color-meeting-soft); color: #000; }

.subcard .title {
  font-size: 22px;
}

.subcard .time {
  font-size: 13px;
}

.subnote {
  font-size: 14px;
  opacity: 0.85;
}

.icon {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: rgba(255,255,255,0.18);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 12px;
  flex-shrink: 0;
}

.row {
  display: flex;
  align-items: center;
}

.row.top {
  align-items: flex-start;
}

/* Pad card visuals */
.is-pad { background: transparent !important; }
.pad-card { 
  background: transparent !important; 
  padding: 0; 
  border-radius: var(--radius-lg);
  display:flex;align-items:center;justify-content:center;
}
.pad-image-wrap{width:100%;height:100%;display:flex;align-items:center;justify-content:center}
.pad-image-wrap img{width:60%;height:auto;max-height:100%;object-fit:contain;display:block}
</style>
</head>

<body>
<style>
/* control panel styles (inline so we don't edit head) */
.controls { width: 640px; background: rgba(255,255,255,0.03); padding: 14px; border-radius: 10px; margin-bottom: 18px; }
.controls h3{margin:0 0 8px 0;font-size:14px}
.controls .row{display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:nowrap}
.controls input,.controls select{min-width:0}
.controls label{width:110px;color:var(--muted);font-size:13px}
.controls input[type="color"],.controls input[type="number"],.controls select{padding:6px;border-radius:6px;border:none;background:rgba(255,255,255,0.04);color:var(--text)}
.controls .buttons{display:flex;gap:8px}
.button{padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.06);color:var(--text);border:none;cursor:pointer}
.remove-btn{padding:6px;border-radius:6px;background:rgba(255,255,255,0.03);width:36px;height:36px;display:inline-flex;align-items:center;justify-content:center}
.remove-btn svg{width:16px;height:16px;display:block;fill:#e5e7eb;}
.remove-btn:hover{background:rgba(255,0,0,0.09)}
.remove-btn.small{width:auto;height:auto;padding:4px 6px;border-radius:6px}

/* card control layout */
.card-row{display:flex;align-items:flex-start;gap:10px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02)}
.card-row .content{flex:1;min-width:0}
.sub-block{margin-left:20px;border-left:2px dashed rgba(255,255,255,0.08);padding-left:10px;margin-top:8px}
.sub-list{display:flex;flex-direction:column;gap:6px;margin-top:6px}
.sub-item{display:grid;grid-template-columns:1fr;gap:6px;border-radius:6px;padding:8px;background:rgba(255,255,255,0.02);width:100%}
.sub-item .sub-top{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.sub-item .sub-bottom{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.sub-item .time-group{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.time-input{padding:6px;border-radius:6px;border:none;background:rgba(255,255,255,0.03);color:var(--text);width:120px}
.time-toggle{margin-left:6px;padding:6px;border-radius:6px;background:rgba(255,255,255,0.02)}
.invalid{outline:2px solid rgba(255,77,79,0.8);}
.preview{height:34px;border-radius:8px;margin-bottom:8px} 
.muted{color:var(--muted);font-size:12px}
.field{padding:6px;border-radius:6px;border:none;background:rgba(255,255,255,0.03);color:var(--text)}
.icon-btn{padding:6px;border-radius:6px;background:rgba(255,255,255,0.03);display:inline-flex;align-items:center;justify-content:center;border:none;cursor:pointer}
.icon-btn svg{width:16px;height:16px;fill:#e5e7eb}
</style>

<div class="controls" id="controlsPanel">
  <h3>Event generator âš¡</h3>
  <div class="row">
    <label>Weekday</label>
    <input id="weekdayInput" class="field" type="text" placeholder="ONSDAG" value="ONSDAG" style="flex:1">
  </div>
  <div class="row">
    <label>Date</label>
    <input id="dateInput" class="field" type="text" placeholder="1. april" value="1. april" style="flex:1">
  </div>
  <div class="row" style="align-items:center">
    <label>Preset</label>
    <select id="palettePreset" class="field">
      <option value="ocean">Ocean (dark)</option>
      <option value="sunset">Sunset (dark)</option>
      <option value="forest">Forest (dark)</option>
      <option value="mono">Monochrome (dark)</option>
      <option value="custom">Customâ€¦</option>
    </select>
  </div>
  <div id="customBlock" style="display:none">
    <div class="preview" id="palettePreview"></div>
    <div class="row"><label>Background</label><input type="color" id="bgColor" value="#0b0b0b"><label style="width:80px">Text</label><input type="color" id="textColor" value="#ffffff"></div>
    <div class="row"><label>Food</label><input type="color" id="colorFood" value="#1f3d1a"><label style="width:80px">Activity</label><input type="color" id="colorActivity" value="#7c2a2a"></div>
    <div class="row"><label>Meeting</label><input type="color" id="colorMeeting" value="#b08a00"><label style="width:80px">Radius</label><input type="number" id="radius" min="8" max="48" value="22"></div>
  </div>
  <div class="row" style="gap:8px;margin:8px 0">
    <button class="button" id="addCardBtn">Add card</button>
  </div>
  <div id="cardControls" style="margin-bottom:8px"></div>
  <div class="row" style="align-items:center">
    <label>Canvas</label>
    <input id="canvasW" type="number" class="field" value="550" min="200" max="4000" style="width:100px">Ã—
    <input id="canvasH" type="number" class="field" value="1860" min="300" max="8000" style="width:100px">
    <span class="muted" style="margin-left:auto">Outline shows full export area</span>
  </div>
  <div class="row buttons">
    <button class="button" id="generateBtn">Generate</button>
    <button class="button" id="exportBtn">Export PNG</button>
    <button class="button remove-btn" id="deleteAllBtn" title="Clear canvas" aria-label="Clear canvas" style="margin-left:6px">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M3 6h18v2H3V6zm2 3h14l-1.5 12.5a2 2 0 0 1-2 1.5H8.5a2 2 0 0 1-2-1.5L5 9zm3-6h8v2H8V3z"/></svg>
      Clear canvas
    </button>
  </div>
  <div class="muted">Tip: Presets update immediately. Choose Custom to edit colors and radius.</div>
</div>

<div class="canvas-container">
  <div class="stage-scaler" id="stageScaler">
    <div class="app" id="appRoot">

      <!-- Rendered content will be injected by generate() -->

    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
// ---------- Simple, refactored state ----------
function getTodayHeader(){
  const d = new Date();
  const weekday = d.toLocaleDateString('fr-FR', { weekday: 'long' }).toUpperCase();
  const date = d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' });
  return { weekday, date };
}
const SUBJECTS = {
  food: { label: 'Food', icon: 'ðŸ½ï¸' },
  activity: { label: 'Activity', icon: 'ðŸƒ' },
  meeting: { label: 'Meeting', icon: 'ðŸ‘¥' },
  pad: { label: 'Pad (image)', icon: '' },
};

// Dark-only presets with per-subject colors
const PRESETS = {
  ocean: {
    name: 'Ocean',
    bg: '#0b1220', text:'#e6f0f6',
    subjects: { food:'#036b66', activity:'#0a3a5a', meeting:'#1e293b' },
    radius: 22,
  },
  sunset: {
    name: 'Sunset',
    bg: '#1a0b0b', text:'#fff5f3',
    subjects: { food:'#8a3a28', activity:'#a24141', meeting:'#c27c2a' },
    radius: 22,
  },
  forest: {
    name: 'Forest',
    bg: '#0b0f0b', text:'#eef7f0',
    subjects: { food:'#1f3d1a', activity:'#2e3a24', meeting:'#355f2a' },
    radius: 22,
  },
  mono: {
    name: 'Mono',
    bg: '#0b0b0b', text:'#f3f4f6',
    subjects: { food:'#2b2b2b', activity:'#3a3a3a', meeting:'#4b4b4b' },
    radius: 22,
  }
};

const state = {
  header: getTodayHeader(),
  preset: 'ocean',
  custom: {
    bg: '#0b0b0b', text:'#ffffff',
    subjects: { food:'#1f3d1a', activity:'#7c2a2a', meeting:'#b08a00' },
    radius: 22,
  },
  cards: [],
  canvas: { width: 550, height: 1300 },
  unitCardHeight: 0,
};

// ---------- Utilities ----------
function hexToRgb(hex){
  const h = hex.replace('#','');
  return { r: parseInt(h.slice(0,2),16), g: parseInt(h.slice(2,4),16), b: parseInt(h.slice(4,6),16) };
}
function mixHex(hex, amount){ // mix with white for soft background
  const {r,g,b} = hexToRgb(hex);
  const R = Math.round(r + (255 - r) * amount);
  const G = Math.round(g + (255 - g) * amount);
  const B = Math.round(b + (255 - b) * amount);
  return `rgb(${R},${G},${B})`;
}
function setCssVars(colors){
  const root = document.documentElement.style;
  root.setProperty('--bg', colors.bg);
  root.setProperty('--text', colors.text);
  root.setProperty('--muted', 'rgba(255,255,255,0.7)');
  root.setProperty('--color-food', colors.subjects.food);
  root.setProperty('--color-activity', colors.subjects.activity);
  root.setProperty('--color-meeting', colors.subjects.meeting);
  root.setProperty('--color-food-soft', mixHex(colors.subjects.food, 0.25));
  root.setProperty('--color-activity-soft', mixHex(colors.subjects.activity, 0.25));
  root.setProperty('--color-meeting-soft', mixHex(colors.subjects.meeting, 0.25));
  root.setProperty('--radius-lg', (colors.radius||22)+'px');
  root.setProperty('--radius-md', Math.max(8, (colors.radius||22) - 6)+'px');
}

function setCanvasVars(width, height){
  const root = document.documentElement.style;
  root.setProperty('--canvas-w', width + 'px');
  root.setProperty('--canvas-h', height + 'px');
}

function currentColors(){
  if (state.preset === 'custom') return state.custom;
  const p = PRESETS[state.preset] || PRESETS.ocean;
  return { bg:p.bg, text:p.text, subjects:p.subjects, radius:p.radius };
}

function updatePalettePreview(){
  const preview = document.getElementById('palettePreview');
  if (!preview) return;
  const c = currentColors();
  preview.style.background = `linear-gradient(90deg, ${c.subjects.food}, ${c.subjects.activity}, ${c.subjects.meeting})`;
  preview.textContent = 'Preview';
}

// Fit the canvas stage into the viewport below the controls without scrolling
// no viewport scaling; canvas is rendered at exact pixel size

// ---------- Persistence (localStorage + cookies fallback) ----------
const STORAGE_KEY = 'event_state';
const COOKIE_PREFIX = 'evs_';
const COOKIE_COUNT = 'evs_count';

function cloneStateForCookie(){
  // Cookies have very limited space; strip large image data
  const s = JSON.parse(JSON.stringify(state));
  if (s.cards && s.cards.length){
    s.cards.forEach(c=>{ if (c.padImage) c.padImage = ''; });
  }
  return s;
}

function serializeState(stripImages=false){
  try {
    const s = stripImages ? cloneStateForCookie() : state;
    return JSON.stringify(s);
  } catch(e){ return ''; }
}

function persistLocal(){
  try{ localStorage.setItem(STORAGE_KEY, serializeState(false)); }catch(e){}
}

function loadLocal(){
  try{ const txt = localStorage.getItem(STORAGE_KEY); if (!txt) return null; return JSON.parse(txt); }catch(e){ return null; }
}

function setCookie(name, value, days){
  const d = new Date(); d.setTime(d.getTime() + (days*24*60*60*1000));
  const expires = '; expires=' + d.toUTCString();
  document.cookie = name + '=' + encodeURIComponent(value) + expires + '; path=/';
}
function getCookie(name){
  const cname = name + '=';
  const ca = document.cookie.split(';');
  for (let i=0;i<ca.length;i++){ let c = ca[i].trim(); if (c.indexOf(cname)===0) return decodeURIComponent(c.substring(cname.length,c.length)); }
  return null;
}
function deleteCookie(name){ setCookie(name,'',-1); }

function persistCookies(){
  const data = serializeState(true); // stripped images
  // clear previous chunks
  const prevCount = parseInt(getCookie(COOKIE_COUNT)||'0',10) || 0;
  for(let i=0;i<prevCount;i++) deleteCookie(COOKIE_PREFIX + i);
  deleteCookie(COOKIE_COUNT);
  // chunk the data into ~3500 char per cookie
  const chunkSize = 3500;
  const chunks = Math.ceil(data.length / chunkSize);
  for(let i=0;i<chunks;i++){
    const part = data.slice(i*chunkSize, (i+1)*chunkSize);
    setCookie(COOKIE_PREFIX + i, part, 30);
  }
  setCookie(COOKIE_COUNT, String(chunks), 30);
}

function loadCookies(){
  const count = parseInt(getCookie(COOKIE_COUNT)||'0',10) || 0;
  if (!count) return null;
  let data = '';
  for(let i=0;i<count;i++){
    const part = getCookie(COOKIE_PREFIX + i) || '';
    data += part;
  }
  try{ return JSON.parse(data); }catch(e){ return null; }
}

function persistState(){
  persistLocal();
  persistCookies();
}

function restoreState(){
  // Prefer localStorage (can store images); fall back to cookies
  const local = loadLocal();
  if (local){ Object.assign(state, local); return true; }
  const cookies = loadCookies();
  if (cookies){ Object.assign(state, cookies); return true; }
  return false;
}

// Measure the height of an empty food card to use as pad unit height
function measureUnitCardHeight(){
  const app = document.getElementById('appRoot');
  const probe = document.createElement('div');
  probe.className = 'card is-food';
  probe.style.position = 'absolute';
  probe.style.visibility = 'hidden';
  probe.style.left = '-9999px';
  probe.innerHTML = `<div class='row'><div class='icon'>${SUBJECTS.food.icon}</div><div><div class='title'>&nbsp;</div></div></div>`;
  app.appendChild(probe);
  const h = probe.offsetHeight || 200;
  app.removeChild(probe);
  state.unitCardHeight = h;
}

// ---------- Controls rendering ----------
function renderCardControls(){
  const container = document.getElementById('cardControls');
  container.innerHTML = '';
  state.cards.forEach((card, i)=>{
    const row = document.createElement('div');
    row.className = 'card-row';
    const isPad = card.subject === 'pad';
    row.innerHTML = `
      <div class="content">
        ${isPad ? `
          <div style="display:flex;gap:8px;align-items:center;width:100%;flex-wrap:nowrap">
            <select class="field card-subject" data-i="${i}" style="min-width:130px">
              ${Object.keys(SUBJECTS).map(k=>`<option value="${k}" ${card.subject===k?'selected':''}>${SUBJECTS[k].label}</option>`).join('')}
            </select>
            <input type="file" accept="image/*" class="field pad-file" data-i="${i}" style="flex:1;min-width:160px">
            <input type="number" min="1" value="${card.padUnits||1}" class="field pad-units" data-i="${i}" title="Pad height (units)" style="width:120px"/>
            <button class="remove-btn" data-i="${i}" title="Remove card" aria-label="Remove card" style="margin-left:auto">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M3 6h18v2H3V6zm2 3h14l-1.5 12.5a2 2 0 0 1-2 1.5H8.5a2 2 0 0 1-2-1.5L5 9zm3-6h8v2H8V3z"/></svg>
            </button>
          </div>
        ` : `
          <div class="card-top" style="display:flex;gap:8px;align-items:center;width:100%;flex-wrap:nowrap;justify-content:space-between">
            <div style="display:flex;gap:8px;align-items:center;flex:1;min-width:0">
              <select class="field card-subject" data-i="${i}" style="min-width:130px">
                ${Object.keys(SUBJECTS).map(k=>`<option value="${k}" ${card.subject===k?'selected':''}>${SUBJECTS[k].label}</option>`).join('')}
              </select>
              <input type="text" data-i="${i}" class="field card-title" placeholder="Title" value="${card.title||''}" style="flex:1;min-width:160px">
            </div>
            <button class="remove-btn" data-i="${i}" title="Remove card" aria-label="Remove card">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M3 6h18v2H3V6zm2 3h14l-1.5 12.5a2 2 0 0 1-2 1.5H8.5a2 2 0 0 1-2-1.5L5 9zm3-6h8v2H8V3z"/></svg>
            </button>
          </div>
          <div class="card-bottom" style="display:flex;gap:8px;align-items:center;width:100%;flex-wrap:nowrap;margin-top:6px">
            <input type="time" class="time-start field" data-i="${i}" value="${card.timeStart||''}">
            <span>â€”</span>
            <input type="time" class="time-end field" data-i="${i}" value="${card.timeEnd||''}">
            <input type="text" class="field card-location" data-i="${i}" placeholder="Location" value="${card.location||''}" style="min-width:140px;flex:1">
          </div>
        `}
        ${isPad ? `` : `
        <div class="sub-block">
          <div class="muted">Subcards</div>
          <div class="sub-list" data-i="${i}"></div>
          <div style="margin-top:6px">
            <button class="button add-sub" data-i="${i}" style="padding:6px 8px">+ Add subcard</button>
          </div>
        </div>`}
      </div>
    `;
    container.appendChild(row);
  });

  // Attach listeners for card fields
  container.querySelectorAll('.card-title').forEach(inp=>{
    inp.addEventListener('input', (e)=>{ const i=+e.target.dataset.i; state.cards[i].title = e.target.value; generate(); });
  });
  container.querySelectorAll('.card-subject').forEach(sel=>{
    sel.addEventListener('change', (e)=>{ const i=+e.target.dataset.i; state.cards[i].subject = e.target.value; renderCardControls(); generate(); });
  });
  container.querySelectorAll('.time-start').forEach(inp=>{
    inp.addEventListener('input', (e)=>{ const i=+e.target.dataset.i; state.cards[i].timeStart = e.target.value; validateTimePair(i); generate(); });
  });
  container.querySelectorAll('.time-end').forEach(inp=>{
    inp.addEventListener('input', (e)=>{ const i=+e.target.dataset.i; state.cards[i].timeEnd = e.target.value; validateTimePair(i); generate(); });
  });
  container.querySelectorAll('.card-location').forEach(inp=>{
    inp.addEventListener('input', (e)=>{ const i=+e.target.dataset.i; state.cards[i].location = e.target.value; generate(); });
  });
  // pad file handler
  container.querySelectorAll('.pad-file').forEach(inp=>{
    inp.addEventListener('change', (e)=>{
      const i = +e.target.dataset.i; const file = e.target.files && e.target.files[0];
      if (!file) return;
      if (!file.type.startsWith('image/')) { alert('Please select an image file.'); return; }
      const reader = new FileReader();
      reader.onload = () => { state.cards[i].padImage = reader.result; generate(); };
      reader.readAsDataURL(file);
    });
  });
  // pad units handler
  container.querySelectorAll('.pad-units').forEach(inp=>{
    inp.addEventListener('input', (e)=>{ const i=+e.target.dataset.i; const v = Math.max(1, parseInt(e.target.value||'1',10)); state.cards[i].padUnits = v; generate(); });
  });
  container.querySelectorAll('button.remove-btn[data-i]').forEach(btn=>{
    btn.addEventListener('click', (e)=>{ const i=+e.currentTarget.dataset.i; removeCardAt(i); });
  });

  // Add subcard buttons
  container.querySelectorAll('button.add-sub').forEach(btn=>{
    btn.addEventListener('click', (e)=>{ const i=+e.currentTarget.dataset.i; addSubcard(i); });
  });

  // Render sublists
  container.querySelectorAll('.sub-list').forEach(list=>{
    const i = +list.dataset.i;
    const subs = state.cards[i].subs || [];
    list.innerHTML = '';
    subs.forEach((s,si)=>{
      const el = document.createElement('div');
      el.className = 'sub-item';
      el.innerHTML = `
        <div class="sub-top">
          <select class="field sub-subject" data-i="${i}" data-si="${si}" style="min-width:120px">
            ${Object.keys(SUBJECTS).map(k=>`<option value="${k}" ${s.subject===k?'selected':''}>${SUBJECTS[k].label}</option>`).join('')}
          </select>
          <input class="field sub-title" data-i="${i}" data-si="${si}" placeholder="Sub title" value="${s.title||''}" style="flex:1;min-width:140px">
          <button class="remove-btn small" data-i="${i}" data-si="${si}" title="Remove sub" aria-label="Remove sub" style="margin-left:auto">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M3 6h18v2H3V6zm2 3h14l-1.5 12.5a2 2 0 0 1-2 1.5H8.5a2 2 0 0 1-2-1.5L5 9zm3-6h8v2H8V3z"/></svg>
          </button>
        </div>
        <div class="sub-bottom">
          <div class="time-group">
            <input type="time" class="field sub-time-start" data-i="${i}" data-si="${si}" value="${s.timeStart||''}">
            <span>â€”</span>
            <input type="time" class="field sub-time-end" data-i="${i}" data-si="${si}" value="${s.timeEnd||''}">
            <input class="field sub-location" data-i="${i}" data-si="${si}" placeholder="Location" value="${s.location||''}" style="min-width:140px">
          </div>
        </div>
      `;
      list.appendChild(el);
    });

    // listeners
    list.querySelectorAll('.sub-title').forEach(inp=>{
      inp.addEventListener('input', (e)=>{ const i=+e.target.dataset.i, si=+e.target.dataset.si; state.cards[i].subs[si].title = e.target.value; generate(); });
    });
    list.querySelectorAll('.sub-subject').forEach(sel=>{
      sel.addEventListener('change', (e)=>{ const i=+e.target.dataset.i, si=+e.target.dataset.si; state.cards[i].subs[si].subject = e.target.value; generate(); });
    });
    list.querySelectorAll('.sub-time-start').forEach(inp=>{
      inp.addEventListener('input', (e)=>{ const i=+e.target.dataset.i, si=+e.target.dataset.si; state.cards[i].subs[si].timeStart = e.target.value; validateSubTimePair(i,si); generate(); });
    });
    list.querySelectorAll('.sub-time-end').forEach(inp=>{
      inp.addEventListener('input', (e)=>{ const i=+e.target.dataset.i, si=+e.target.dataset.si; state.cards[i].subs[si].timeEnd = e.target.value; validateSubTimePair(i,si); generate(); });
    });
    list.querySelectorAll('.sub-location').forEach(inp=>{
      inp.addEventListener('input', (e)=>{ const i=+e.target.dataset.i, si=+e.target.dataset.si; state.cards[i].subs[si].location = e.target.value; generate(); });
    });
    list.querySelectorAll('button.remove-btn.small').forEach(btn=>{
      btn.addEventListener('click', (e)=>{ const i=+e.currentTarget.dataset.i, si=+e.currentTarget.dataset.si; removeSubcard(i,si); });
    });
  });
}

// ---------- Validation ----------
function timeToMinutes(v){ if(!v) return null; const parts=v.split(':'); if(parts.length!==2) return null; return parseInt(parts[0],10)*60+parseInt(parts[1],10); }
function validateTimePair(i){
  const s = state.cards[i].timeStart, e = state.cards[i].timeEnd;
  const ok = !s || !e || timeToMinutes(s) < timeToMinutes(e);
  const sEl = document.querySelector(`.time-start[data-i="${i}"]`);
  const eEl = document.querySelector(`.time-end[data-i="${i}"]`);
  [sEl,eEl].forEach(el=>{ if(!el) return; el.classList.toggle('invalid', !ok && s && e); });
}
function validateSubTimePair(i,si){
  const s = state.cards[i].subs[si].timeStart, e = state.cards[i].subs[si].timeEnd;
  const ok = !s || !e || timeToMinutes(s) < timeToMinutes(e);
  const sEl = document.querySelector(`.sub-time-start[data-i="${i}"][data-si="${si}"]`);
  const eEl = document.querySelector(`.sub-time-end[data-i="${i}"][data-si="${si}"]`);
  [sEl,eEl].forEach(el=>{ if(!el) return; el.classList.toggle('invalid', !ok && s && e); });
}

// ---------- State mutators ----------
function addCard(){
  state.cards.push({ subject:'food', title:'', timeStart:'', timeEnd:'', location:'', subs:[], padImage:'' });
  renderCardControls();
  generate();
}
function removeCardAt(index){
  if (index<0 || index>=state.cards.length) return;
  state.cards.splice(index,1);
  renderCardControls();
  generate();
}
function addSubcard(cardIndex){
  state.cards[cardIndex].subs.push({ subject: state.cards[cardIndex].subject, title:'', timeStart:'', timeEnd:'', location:'' });
  renderCardControls();
  generate();
}
function removeSubcard(cardIndex, subIndex){
  state.cards[cardIndex].subs.splice(subIndex,1);
  renderCardControls();
  generate();
}
function clearAll(){
  state.cards = [];
  // reset header to today's date and sync inputs
  if (typeof getTodayHeader === 'function') {
    state.header = getTodayHeader();
    const w = document.getElementById('weekdayInput');
    const d = document.getElementById('dateInput');
    if (w) w.value = state.header.weekday;
    if (d) d.value = state.header.date;
  }
  renderCardControls();
  generate();
}

// ---------- Rendering of final layout ----------
function generate(){
  const colors = currentColors();
  setCssVars(colors);
  const app = document.getElementById('appRoot');
  let html = '';
  html += `<div class="header"><div class="weekday">${state.header.weekday}</div><div class="date">${state.header.date}</div></div>`;
  state.cards.forEach(card=>{
    const subj = card.subject || 'food';
    if (subj === 'pad') {
      const units = Math.max(1, card.padUnits||1);
      const px = Math.max(1, state.unitCardHeight||200) * units;
      html += `<div class='card pad-card is-pad' style='min-height:${px}px'>`;
      if (card.padImage) {
        html += `<div class='pad-image-wrap'><img src='${card.padImage}' alt='Pad image'></div>`;
      } else {
        html += `<div class='pad-image-wrap'></div>`;
      }
      html += `</div>`;
    } else {
      const icon = SUBJECTS[subj].icon;
      const ctime = (card.timeStart && card.timeEnd && timeToMinutes(card.timeStart)<timeToMinutes(card.timeEnd)) ? `${card.timeStart}â€“${card.timeEnd}` : '';
      const cloc = (card.location||'').trim();
      let timeText = '';
      if (ctime && cloc) timeText = `${ctime} Â· ${cloc}`;
      else if (ctime) timeText = ctime;
      else if (cloc) timeText = cloc;
      const timeHtml = timeText ? `<div class='time'>${timeText}</div>` : '';
      html += `<div class='card is-${subj}'>`;
      html += `<div class='row'><div class='icon'>${icon}</div><div>${timeHtml}<div class='title'>${card.title||''}</div></div></div>`;
      if ((card.subs||[]).length){
        html += `<div class='stack'>`;
        card.subs.forEach((s)=>{
          const ssubj = s.subject || subj;
          const sicon = SUBJECTS[ssubj].icon;
          const stime = (s.timeStart && s.timeEnd && timeToMinutes(s.timeStart)<timeToMinutes(s.timeEnd)) ? `${s.timeStart}â€“${s.timeEnd}` : '';
          const sloc = (s.location||'').trim();
          let sText = '';
          if (stime && sloc) sText = `${stime} Â· ${sloc}`;
          else if (stime) sText = stime;
          else if (sloc) sText = sloc;
          const sTimeHtml = sText ? `<div class='time'>${sText}</div>` : '';
          html += `<div class='subcard is-${ssubj}-soft'><div class='row'><div class='icon'>${sicon}</div><div>${sTimeHtml}<div class='title'>${s.title||''}</div></div></div></div>`;
        });
        html += `</div>`;
      }
      html += `</div>`;
    }
  });
  app.innerHTML = html;
  // persist after every render to capture changes
  persistState();
}

// ---------- Presets & custom UI ----------
function applyPreset(name){
  state.preset = name;
  const customBlock = document.getElementById('customBlock');
  if (name === 'custom') {
    customBlock.style.display = 'block';
    // sync inputs with current custom state
    document.getElementById('bgColor').value = state.custom.bg;
    document.getElementById('textColor').value = state.custom.text;
    document.getElementById('colorFood').value = state.custom.subjects.food;
    document.getElementById('colorActivity').value = state.custom.subjects.activity;
    document.getElementById('colorMeeting').value = state.custom.subjects.meeting;
    document.getElementById('radius').value = state.custom.radius;
  } else {
    customBlock.style.display = 'none';
  }
  updatePalettePreview();
  generate(); // immediate update
}

// preview updates for custom inputs
['bgColor','textColor','colorFood','colorActivity','colorMeeting','radius'].forEach(id=>{
  document.addEventListener('input', (e)=>{
    if (e.target && e.target.id === id){
      if (state.preset !== 'custom') return; // only when custom
      if (id==='bgColor') state.custom.bg = e.target.value;
      if (id==='textColor') state.custom.text = e.target.value;
      if (id==='colorFood') state.custom.subjects.food = e.target.value;
      if (id==='colorActivity') state.custom.subjects.activity = e.target.value;
      if (id==='colorMeeting') state.custom.subjects.meeting = e.target.value;
      if (id==='radius') state.custom.radius = +e.target.value || 22;
      updatePalettePreview();
      generate();
    }
  });
});

function wireHeaderInputs(){
  document.getElementById('weekdayInput').addEventListener('input', (e)=>{ state.header.weekday = e.target.value; generate(); });
  document.getElementById('dateInput').addEventListener('input', (e)=>{ state.header.date = e.target.value; generate(); });
}

function wirePreset(){
  const select = document.getElementById('palettePreset');
  select.addEventListener('change', (e)=> applyPreset(e.target.value));
}

function wireActions(){
  document.getElementById('addCardBtn').addEventListener('click', addCard);
  document.getElementById('generateBtn').addEventListener('click', generate);
  document.getElementById('exportBtn').addEventListener('click', exportPNG);
  document.getElementById('deleteAllBtn').addEventListener('click', ()=>{ if (confirm('Delete all cards?')) clearAll(); });
  document.getElementById('canvasW').addEventListener('input', (e)=>{ const w= Math.max(200, parseInt(e.target.value||'550',10)); state.canvas.width = w; setCanvasVars(state.canvas.width, state.canvas.height); });
  document.getElementById('canvasH').addEventListener('input', (e)=>{ const h= Math.max(300, parseInt(e.target.value||'1860',10)); state.canvas.height = h; setCanvasVars(state.canvas.width, state.canvas.height); });
}

function exportPNG(){
  const element = document.getElementById('appRoot');
  const colors = currentColors();
  const TARGET_W = state.canvas.width;
  const TARGET_H = state.canvas.height;
  html2canvas(element, { backgroundColor: colors.bg, scale: 2, windowWidth: TARGET_W }).then(canvas=>{
    const a = document.createElement('a');
    a.href = canvas.toDataURL('image/png');
    a.download = 'event.png';
    a.click();
  }).catch(err=> alert('Export failed: '+err));
}

// ---------- Init ----------
function init(){
  // start with one example card for convenience
  const hadSaved = restoreState();
  if (!hadSaved){
    state.cards = [
      { subject:'food', title:'Frokost', timeStart:'07:30', timeEnd:'09:00', location:'Suitene', subs:[], padImage:'' },
      { subject:'activity', title:'Aktiviteter', timeStart:'09:00', timeEnd:'16:00', location:'', subs:[ {subject:'food', title:'Lunsj', timeStart:'12:00', timeEnd:'13:00', location:'Festplassen'} ], padImage:'' },
    ];
  }
  setCanvasVars(state.canvas.width, state.canvas.height);
  renderCardControls();
  wireHeaderInputs();
  wirePreset();
  wireActions();
  // reflect restored header/canvas/preset in controls
  document.getElementById('weekdayInput').value = state.header.weekday;
  document.getElementById('dateInput').value = state.header.date;
  document.getElementById('canvasW').value = state.canvas.width;
  document.getElementById('canvasH').value = state.canvas.height;
  document.getElementById('palettePreset').value = state.preset;
  applyPreset(state.preset);
  updatePalettePreview();
  generate();
  measureUnitCardHeight();
}

init();
</script>
</body>
</html>